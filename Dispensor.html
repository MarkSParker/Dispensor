<!DOCTYPE html>
<html data-bs-theme="dark">
<!--

PROGRAM:    Dispensor

PURPOSE:    This a reminder tool for dementia patients. It provides:-

            1. An easy-to-read,contextual time-and-date clock.

            2. A list of daily tasks to be completed; typically medication reminders.

            3. Audio and visual reminders for each task.

            4. An interface for carers to set up and manage tasks and view compliance.

            It is implmented as a single-page web application using ReactJS, and is supplied in
            a single HTML file for ease of deployment and to avoid the need for a web server. All data
            is stored locally in the browser (don't clear browser data if you want to keep the tasks).

TO RUN:     Download the file Dispensor.html and open in any modern web browser (eg, Control-O)

AUTHOR:     Mark S. Parker
            github.com/marksparker

-->
<head>
    <title>Dispensor</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
            crossorigin="anonymous"
            defer></script>

    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" defer></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>

    <!-- CSS -->
    <style>
        .popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: darkgray;
            color: white;
            font-size: 1.3rem;
            padding: 20px 30px;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .popup.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        // ************************** REACTJS COMPONENTS **************************

        const ViewContext = React.createContext();                              // controls which view is displayed
        const PopupContext = React.createContext();                             // lets the popup be used anywhere
        const themes = ["dark", "light"];                                       // supported themes
        const DaysOfWeek = ["Everyday", "Mondays", "Tuesdays", "Wednesdays",    // days of week or every day of week
            "Thursdays", "Fridays", "Saturdays", "Sundays"];
        const NotSet = "Not set";                                               // item is not set

        /**************************************************************************
         * COMPONENT: App                                                         *
         *                                                                        *
         * Parent component of the web site                                       *
         *                                                                        *
         **************************************************************************/
        const App = () => {
            const [view, setView] = React.useState("clock");                    // start on the clock
            const [theme, setTheme] = React.useState(restoreTheme());           // use last set theme or default to dark theme
            const [popup, setPopup] = React.useState("");                       // a fading popup message

            React.useEffect(() => {
                applyTheme(theme);
            }, [theme]);

            return (
                <div>
                <ViewContext.Provider value={{ view, setView }}>
                <PopupContext.Provider value={{ popup, setPopup }}>
                    <Navbar />
                    <Popup>{popup}</Popup>
                    {view === "clock"   && <Clock />}
                    {view === "carer"   && <Carer onToggleTheme={() => setTheme(theme === "dark" ? "light" : "dark")} />}
                    {view === "newtask" && <NewTask />}
                </PopupContext.Provider>
                </ViewContext.Provider>
                </div>
          );
        };

        /**************************************************************************
         * COMPONENT: Navbar                                                      *
         *                                                                        *
         * Implements the top navigation bar                                      *
         *                                                                        *
         **************************************************************************/
        const Navbar = () => {
            const { view, setView } = React.useContext(ViewContext);

            return (
            <nav id="navbar" className="navbar navbar-expand-md bg-body-tertiary pt-0 pb-0">
                <div className="container-fluid">
                <ul className="nav navbar-nav d-flex align-items-center w-100">

                    <li className="nav-item">
                    <a className="nav-link" onClick={() => setView("clock")} >
                        Clock
                    </a>
                    </li>

                    <li className="nav-item">
                    <a className="nav-link" onClick={() => setView("carer")} >
                        Carer
                    </a>
                    </li>

                    <li className="nav-item ms-auto">
                    <svg
                        id="maxarrowsvg"
                        className="cursor-pointer"
                        width="24"
                        height="24"
                        xmlns="http://www.w3.org/2000/svg"
                        onClick={onFullScreen}
                    >
                        <path
                        d="M10.71,14.71,5.41,20H10a1,1,0,0,1,0,2H4a2,2,0,0,1-1.38-.56l0,0s0,0,0,0A2,2,0,0,1,2,20V14a1,1,0,0,1,2,0v4.59l5.29-5.3a1,1,0,0,1,1.42,1.42ZM21.44,2.62s0,0,0,0l0,0A2,2,0,0,0,20,2H14a1,1,0,0,0,0,2h4.59l-5.3,5.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L20,5.41V10a1,1,0,0,0,2,0V4A2,2,0,0,0,21.44,2.62Z"
                        fill="#231f20"
                        />
                        MAX
                    </svg>
                    </li>

                    <li className="nav-item">
                    <svg
                        id="minarrowsvg"
                        className="d-none cursor-pointer"
                        width="24"
                        height="24"
                        xmlns="http://www.w3.org/2000/svg"
                        onClick={onExitFullScreen}
                    >
                        <path
                        d="M19.1429 10H14M14 10V4.85714M14 10L20 4"
                        stroke="#000000"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        />
                        <path
                        d="M4.99996 14H9.99996M9.99996 14V19M9.99996 14L4 20"
                        stroke="#000000"
                        strokeWidth="2"
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        />
                        MIN
                    </svg>
                    </li>
                </ul>
                </div>
            </nav>
            );
        }

        /**************************************************************************
         * COMPONENT: Clock                                                       *
         *                                                                        *
         * Displays the first screen date/time clock.                             *
         *                                                                        *
         **************************************************************************/
        const Clock = () => {
            const [now, setNow] = React.useState(new Date());
            const tick = () => { setNow(new Date()); }

            React.useEffect(() => {
                const timerID = setInterval(() => tick(), 500);
                return () => clearInterval(timerID);
            }, []);

            // Do all the formatting, padding etc
            const minute = ("0" + now.getMinutes()).slice(-2);
            const hour24 = now.getHours();
            const phase = getPhaseOfDay(hour24);
            const amPm = hour24 < 12 ? "A.M." : "P.M.";
            const dayName = now.toLocaleDateString("default", { weekday: "long"});
            const day = now.getDate();
            const month = now.toLocaleString("default", { month: "long" });
            const year = now.getFullYear();

            // Convert to 12 hr clock
            const hour12 = hour24 == 0 ? 12 : (hour24 > 12 ? hour24 - 12 : hour24);

            return (
              <div className="text-center pt-2">
                <div>
                  <div style={{ fontSize: "15vw", lineHeight: 1 }}>{dayName}</div>
                </div>

                <div>
                  <span style={{ fontSize: "6vw" }}>{phase}</span>
                </div>

                <div>
                  <span style={{ fontSize: "10vw" }}>{hour12}:{minute} </span>
                  <span style={{ fontSize: "2.5vw" }}>{amPm}</span>
                </div>

                <div>
                  <div style={{ fontSize: "5vw" }}>{day} {month} {year}</div>
                </div>
              </div>
            );
        }

        /**************************************************************************
         * COMPONENT: Carer                                                       *
         *                                                                        *
         * Displays the carer interface.                                          *
         *                                                                        *
         **************************************************************************/
        const Carer = ({ onToggleTheme }) => {
            const { view, setView } = React.useContext(ViewContext);
            const tasks = restoreTasks();

            console.log("List of tasks: ", tasks);

            return (
                <div className="text-center pt-2">
                    <h2>List of Tasks</h2>

                    {tasks.map((t) => (
                        <div key={t.id}>
                        <p>Id:           {t.id}</p>
                        <p>Instructions: {t.instructions}</p>
                        <p>On days:      {t.selectedDays}</p>
                        <p>At time:      {t.timeOfDay}</p>
                        </div>
                        ))}

                    <PrimaryButton onClick={() => onToggleTheme()}>
                        Toggle Theme
                    </PrimaryButton>

                    <PrimaryButton onClick={() => setView("newtask")}>
                        Add Task
                    </PrimaryButton>
                </div>
            );
        }

        /**************************************************************************
         * COMPONENT: Popup                                                       *
         *                                                                        *
         * Puts up a message box and fades it out after a few secs.               *
         *                                                                        *
         **************************************************************************/
        const Popup = () => {
            const { popup, setPopup } = React.useContext(PopupContext);

            let show = popup ? "show" : "noshow";

            React.useEffect(() => {
                if (!popup)
                    return;
                setTimeout(() => { setPopup(""); }, 3000);                      // fade out
            }, [popup]);

            return (
                <div className={`popup ${show}`}>
                    {popup}
                </div>
            );
        }

        /**************************************************************************
         * COMPONENT: Checkbox                                                    *
         *                                                                        *
         * Check box type input                                                   *
         *                                                                        *
         **************************************************************************/
        const Checkbox = ({ id, label, className = "", ...props }) => {
            return (
                <div className={`form-check mb-2 ${className}`}>
                    <input
                        type="checkbox"
                        className="form-check-input"
                        id={id}
                        {...props}
                    />
                    <label className="form-check-label" htmlFor={id}>
                        {label}
                    </label>
                </div>
            );
        };

        /**************************************************************************
         * COMPONENT: CheckboxGroup                                               *
         *                                                                        *
         * Formatted group of check boxes and labels                              *
         *                                                                        *
         **************************************************************************/
        const CheckboxGroup = ({ items, values, onChange }) => {
          return (
            <div>
              {items.map((item) => (
                <Checkbox
                  key={item}
                  id={item}
                  label={item}
                  checked={values.includes(item)}
                  onChange={() => onChange(item)}
                />
              ))}
            </div>
          );
        };

        /**************************************************************************
         * COMPONENT: PrimaryButton                                               *
         *                                                                        *
         * Front-end prmary buttons                                               *
         *                                                                        *
         **************************************************************************/
        const PrimaryButton = ({ children, className = "", ...props }) => {
          return (
            <button
              type="button"
              className={`btn btn-primary m-2 ${className}`}
              {...props}
            >
              {children}
            </button>
          );
        };

        /**************************************************************************
         * COMPONENT: FormRow                                                     *
         *                                                                        *
         * Container for a form row                                               *
         *                                                                        *
         **************************************************************************/
        const FormRow = ({ children }) => {
            return <div className="mb-3">{children}</div>;
        };

        /**************************************************************************
         * COMPONENT: TextArea                                                    *
         *                                                                        *
         * Container for forms rows                                               *
         *                                                                        *
         **************************************************************************/
        const TextArea = ({ id, label, ...props }) => {
            return (
                <FormRow>
                    <label htmlFor={id} className="form-label">{label}</label>
                    <textarea id={id} className="form-control" {...props} />
                </FormRow>
            );
        };

        /**************************************************************************
         * COMPONENT: DaysOfWeekSelector                                          *
         *                                                                        *
         * Selects a day of week, or all days in the week. Note DaysOfWeek        *
         * has 8 values because it contains "Everyday" as well as normal days.    *
         *                                                                        *
         **************************************************************************/
        const DaysOfWeekSelector = ({ value, onChange }) => {

            // Handler: A day was (un)ticked
            function toggleDay(day) {
                const isEveryday = day === "Everyday";
                const isTicking = !value.includes(day);
                let newSelection = [];

                if (isEveryday) {
                    // Everyday toggles all or none
                    newSelection = isTicking ? [...DaysOfWeek] : [];
                } else {
                    // Toggle a single day
                    newSelection = isTicking
                        ? [...value, day]
                        : value.filter(d => d !== day);

                    // Remove everyday and put back only if it applies
                    newSelection = newSelection.filter(d => d !== "Everyday");
                    if (newSelection.length === 7) {
                        newSelection = [...newSelection, "Everyday"];
                    }
                }

                // Put the new selection of days into state
                onChange(newSelection);
            }

            return (
                <div>
                    {DaysOfWeek.map(day => (
                        <div key={day}>
                            <input
                                id={day}
                                type="checkbox"
                                checked={value.includes(day)}
                                onChange={() => toggleDay(day)}
                            />
                            <label htmlFor={day} className="ms-3 mb-1">
                                {day}
                            </label>
                        </div>
                    ))}
                </div>
            );
        };

        /**************************************************************************
         * COMPONENT: TimeOfDaySelector                                           *
         *                                                                        *
         * Selects a time of day with 15 minute granularity. To avoid ambiguity   *
         * midnight is not allowed.                                               *
         *                                                                        *
         **************************************************************************/
        const TimeOfDaySelector = ({ id, onChange }) => {

            // TODO: Only offer time slots where there isn't already a task

            var options = [{ value: NotSet, label: NotSet }]
            for (let hour = 0; hour <= 23; hour++) {
                for (let minute = 0; minute <= 45; minute += 15) {

                    // midnight not allowed
                    if (hour === 0 && minute === 0)
                        continue;

                    // Add an option
                    let hour_str = String(hour).padStart(2, '0');
                    let minute_str = String(minute).padStart(2, '0');
                    options.push({
                        value: `${hour_str}${minute_str}`,
                        label: `${hour_str}:${minute_str}`
                    });
                }
            }

            return (
                <select id={id} onChange={onChange}>
                    {options.map((o) => (
                        <option value={o.value} key={o.value}>{o.label}</option>
                    ))}
                </select>
            )
        };

        /**************************************************************************
         * COMPONENT: NewTask                                                     *
         *                                                                        *
         * Add a new task                                                         *
         *                                                                        *
         **************************************************************************/
        const NewTask = () => {
            const { view, setView } = React.useContext(ViewContext);
            const { popup, setPopup } = React.useContext(PopupContext);

            // React state for the form
            const [instructions, setInstructions] = React.useState("");
            const [selectedDays, setSelectedDays] = React.useState([]);
            const [timeOfDay, setTimeOfDay] = React.useState(NotSet);

            // Derived state: is the Save button disabled?
            const disableSaveTask =
                instructions.trim() === "" ||
                selectedDays.length === 0  ||
                timeOfDay === NotSet;

            // Hande click of save new task button
            function handleSaveTaskButton() {
                // Get the current tasks array
                let tasks = restoreTasks();

                // Get an ID number for the next task
                let highestID = tasks.reduce((largest, element) => Math.max(largest, element.id), 0);

                // Create a new task array element
                let newTask = {
                    id: highestID + 1,
                    instructions: instructions,
                    selectedDays: selectedDays,
                    timeOfDay: timeOfDay
                };

                // Store the new task
                tasks = [...tasks, newTask];
                storeTasks(tasks);

                // Report and return to the carer page
                setPopup("New task saved!")
                setView("carer");
            }

            return (
                <div className="container my-5">
                    <div className="row justify-content-center">
                        <div className="col-4">
                            <h2>New Task</h2>
                        </div>
                    </div>

                    <div className="row">
                        <label htmlFor="instructions">Instructions:</label>
                    </div>

                    <div className="row">
                        <textarea
                            id="instructions"
                            placeholder="Enter instructions here..."
                            rows="5"
                            cols="80"
                            value={instructions}
                            onChange={(e) => setInstructions(e.target.value)}
                        />
                    </div>

                    <div className="row justify-content-center">
                        <div className="col-6">
                            <h3 className="my-4">
                                Which day(s) of the week should the task be performed?
                            </h3>

                            <DaysOfWeekSelector
                                value={selectedDays}
                                onChange={(days) => setSelectedDays(days)}
                                className="m-2"
                            />
                        </div>

                        <div className="col-6">
                            <h3 className="my-4">
                                What time of day should the task be performed?
                            </h3>

                            <TimeOfDaySelector
                                value={timeOfDay}
                                onChange={(e) => setTimeOfDay(e.target.value)}
                                className="m-2"
                            />

                            <p className="mt-4">
                                Note that to avoid confusion as to which day they were done
                                tasks cannot be set for midnight. Tasks can only be set on the
                                quarter hours and multiple tasks cannot be set for the exact
                                same time (instead edit the existing task in that time slot.)
                            </p>
                        </div>
                    </div>

                    <div className="row justify-content-center m-3">
                        <div className="col-auto">
                            <PrimaryButton onClick={() => setView("carer")}> Cancel </PrimaryButton>
                        </div>
                        <div className="col-auto">
                            <PrimaryButton onClick={handleSaveTaskButton} disabled={disableSaveTask}> Save Task </PrimaryButton>
                        </div>
                    </div>
                </div>
            );
        };


        // ************************** JAVASCRIPT FUNCTIONS **************************

        /**
         * Apply the selected theme to the document and store in local storage
         *
         * @param {string} theme - "light" or "dark"
         */
        const applyTheme = (theme) => {
            document.documentElement.setAttribute("data-bs-theme", theme);
            localStorage.setItem("dispensor.configs.theme", theme);
        }

        /**
         * Restore the saved theme from local storage
         * or set to default if none saved.
         *
         */
        const restoreTheme = () => {
            let savedTheme = localStorage.getItem("dispensor.configs.theme");
            if (!themes.includes(savedTheme))
                savedTheme = themes[0];
            return savedTheme;
        }

        /**
         * Enter full-screen mode
         *
         */
        const onFullScreen = () => {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.mozRequestFullScreen) {                             // Firefox
                elem.mozRequestFullScreen();
            } else if (elem.webkitRequestFullscreen) {                          // Chrome, Safari and Opera
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {                              // IE/Edge
                elem.msRequestFullscreen();
            }
            document.getElementById("maxarrowsvg").classList.add("d-none");
            document.getElementById("minarrowsvg").classList.remove("d-none");
        }

        /**
         * Exit full-screen mode
         *
         */
        const onExitFullScreen = () => {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {                          // Firefox
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {                         // Chrome, Safari and Opera
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {                             // IE, Edge
                document.msExitFullscreen();
            }
            document.getElementById("maxarrowsvg").classList.remove("d-none");
            document.getElementById("minarrowsvg").classList.add("d-none");
        }

        /**
         * Determine the 'phase' of the day based on the 24-hour value
         *
         * NIGHT:       21:00 - 00:00
         * PRE-DAWN:    00:00 - 07:00
         * MORNING:     07:00 - 12:00
         * AFTERNOON:   12:00 - 18:00
         * EVENING:     18:00 - 21:00
         *
         * @param {number} hour - Hour of day in 24hr clock
         *
         **/
        function getPhaseOfDay(hour) {
            switch (hour)
            {
                case 0:
                case 1:
                case 2:
                case 3:
                case 4:
                case 5:
                case 6:
                    return "PRE-DAWN";

                case 7:
                case 8:
                case 9:
                case 10:
                case 11:
                    return "MORNING";

                case 12:
                case 13:
                case 14:
                case 15:
                case 16:
                case 17:
                    return "AFTERNOON";

                case 18:
                case 19:
                case 20:
                    return "EVENING";

                default:
                    return "NIGHT";
            }
        }

        /**
         * Obtain the tasks array from local storage. Return an
         * empty array if none.
         *
         **/
        function restoreTasks() {
            // Get the tasks array, as string
            let tasksAsString = localStorage.getItem("dispensor.tasks");

            // If none, create an empty array string
            if (tasksAsString === undefined || tasksAsString === null)
                tasksAsString = "[]";

            // Convert the tasks string to an array object and return it
            let tasksAsArray = JSON.parse(tasksAsString);
            return tasksAsArray;
        }

        /**
         * Store tasks array in local storage.
         *
         **/
        function storeTasks(tasksAsArray) {
            let tasksAsString = JSON.stringify(tasksAsArray);
            localStorage.setItem("dispensor.tasks", tasksAsString);
        }

        // ****************************** RENDER THE APP ****************************
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>